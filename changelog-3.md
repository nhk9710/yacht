# Changelog #3: 주사위 테이블 관통(낙하) 버그 수정

## 날짜
2026-02-11

## 변경 사유
주사위가 가끔 테이블을 관통하여 아래로 무한히 떨어지는 버그가 발생했다.
한번 낙하하면 복구 메커니즘이 없어 해당 주사위의 결과가 비정상적이 되고,
결과 전송이 지연되거나 게임 진행에 문제가 생겼다.

### 원인 분석

| 원인 | 설명 |
|------|------|
| 얇은 테이블 콜라이더 | 반높이 0.15 (전체 0.3)의 얇은 Box 콜라이더로 빠른 주사위가 관통 가능 |
| 고정 타임스텝 | `world.step(1/60)` 단일 스텝 사용 → 프레임 드롭 시 한 스텝에 이동 거리 증가 → 터널링 |
| 복구 메커니즘 없음 | 주사위가 테이블 아래로 떨어져도 감지/복구하는 코드 부재 |
| 댐핑 미설정 | 주사위에 공기 저항이 없어 과도한 속도에 도달 가능 |

## 변경 방향

**다층 방어(Defense in Depth)** 전략으로 터널링을 예방하고, 발생 시에도 자동 복구되도록 변경.

1. **테이블 콜라이더 두께 증가** — 관통 자체를 물리적으로 어렵게
2. **물리 서브스텝(substep) 도입** — 시뮬레이션 정밀도 향상
3. **낙하 감지 & 자동 복구** — 관통 발생 시 안전망
4. **주사위 댐핑 추가** — 과도한 속도 억제

---

## 수정 파일 (1개)

### `client/src/components/three/GameScene.vue`

#### 1. 테이블 물리 콜라이더 두께 증가

```
변경 전: new CANNON.Box(new CANNON.Vec3(4, 0.15, 3))  // 반높이 0.15
         오프셋: new CANNON.Vec3(0, -0.15, 0)

변경 후: new CANNON.Box(new CANNON.Vec3(4, 1.0, 3))   // 반높이 1.0
         오프셋: new CANNON.Vec3(0, -1.0, 0)
```

- 콜라이더 전체 높이: 0.3 → **2.0** (약 6.7배)
- 상단 면은 여전히 Y=0에 위치 (시각적 변화 없음)
- 주사위가 한 프레임에 콜라이더를 완전히 통과하기 어려워짐

#### 2. 물리 월드 컨택트 강성(stiffness) 강화

```typescript
world.defaultContactMaterial.contactEquationStiffness = 1e8
world.defaultContactMaterial.contactEquationRelaxation = 3
```

- 접촉 방정식의 강성을 높여 충돌 시 관통 깊이 최소화
- 기본값 대비 더 "단단한" 충돌 응답

#### 3. 물리 서브스텝(substep) 도입

```
변경 전: world.step(1 / 60)

변경 후: world.step(1 / 120, 1 / 60, 5)
```

- `fixedTimeStep`: 1/60 → **1/120** (120Hz 시뮬레이션)
- `dt`: 1/60 (실제 프레임 간격)
- `maxSubSteps`: 5 (최대 5번 분할)
- 프레임 드롭이 발생해도 작은 단위로 여러 번 시뮬레이션 → 터널링 방지
- 정상 프레임(60fps)에서는 2번의 서브스텝 실행

#### 4. 주사위 댐핑(damping) 추가

```typescript
linearDamping: 0.1,   // 이동 속도 감쇠 (공기 저항 모사)
angularDamping: 0.1,  // 회전 속도 감쇠
```

- 주사위의 최고 속도를 자연스럽게 제한
- 과도한 속도로 인한 터널링 위험 감소
- 값이 작아(0.1) 시각적으로 눈에 띄지 않음

#### 5. 낙하 감지 & 자동 복구 함수 추가

```typescript
function recoverFallenDice()
```

- 매 물리 프레임마다 실행
- Y < -0.5인 주사위 감지 (테이블 표면은 Y=0)
- 감지 시 테이블 중앙 상공(Y=2.0)에 재배치
- 가벼운 낙하 속도(0, -1, 0)와 랜덤 회전 부여
- `console.warn`으로 로그 출력 (디버깅 용도)
- kept 상태이거나 STATIC인 주사위는 무시

---

## 안전장치 요약

| 계층 | 안전장치 | 설명 |
|------|----------|------|
| 1 (예방) | 테이블 콜라이더 두께 증가 | 관통 자체를 물리적으로 차단 |
| 1 (예방) | 컨택트 강성 강화 | 충돌 시 관통 깊이 최소화 |
| 2 (예방) | 물리 서브스텝 (120Hz) | 시뮬레이션 정밀도 향상 |
| 2 (예방) | 주사위 댐핑 | 과도한 속도 억제 |
| 3 (복구) | 낙하 감지 & 재배치 | 만약 관통 시 자동 복구 |
| 기존 | 서버 15초 타임아웃 | 결과 미도착 시 서버 랜덤 생성 |
| 기존 | 10초 강제 정지 | Roller 물리가 안 멈출 경우 |

---

## 성능 영향

| 항목 | 변경 전 | 변경 후 | 영향 |
|------|---------|---------|------|
| 물리 스텝/프레임 | 1회 (1/60) | 2회 (1/120 × 2) | CPU +~1% (미미) |
| 테이블 콜라이더 | 얇은 박스 | 두꺼운 박스 | 충돌 계산 동일 |
| 낙하 체크 | 없음 | 매 프레임 5회 비교 | 무시 가능 |
| 댐핑 계산 | 없음 | 매 스텝 적용 | 기존 물리 연산에 포함 |

> 전체 성능 영향은 체감 불가 수준.

---

## 변경 전후 비교

### 변경 전
```
주사위 → 빠른 속도로 테이블 충돌 → 얇은 콜라이더 관통 → 무한 낙하 → 복구 불가
```

### 변경 후
```
주사위 → 댐핑으로 속도 억제 → 서브스텝으로 정밀 충돌 → 두꺼운 콜라이더 → 관통 차단
(만약 관통 시) → Y < -0.5 감지 → 테이블 위 재배치 → 정상 시뮬레이션 재개
```
